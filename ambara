#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")" && pwd)"
PYTHON="$ROOT/.venv/bin/python"

case "${1:-help}" in
  ingest)    shift; exec "$PYTHON" -m pipeline.cli ingest "$@" ;;
  iterate)   shift; exec "$PYTHON" -m pipeline.cli iterate "$@" ;;
  download)  shift; exec "$PYTHON" -m yt_download.cli download "$@" ;;
  extract)   shift; exec "$PYTHON" -m clip_extraction.cli run "$@" ;;
  vad-only)  shift; exec "$PYTHON" -m clip_extraction.cli vad-only "$@" ;;
  sync)       shift; exec "$PYTHON" -m db_sync.cli sync "$@" ;;
  export)     shift; exec "$PYTHON" -m db_sync.cli export "$@" ;;
  delete-run) shift; exec "$PYTHON" -m db_sync.cli delete-run "$@" ;;
  reset)      shift; exec "$PYTHON" -m db_sync.cli reset "$@" ;;
  cleanup)          shift; exec "$PYTHON" -m db_sync.cli cleanup "$@" ;;
  export-training)  shift; exec "$PYTHON" -m db_sync.cli export-training "$@" ;;
  train)            shift; exec "$PYTHON" -m asr_training.cli train "$@" ;;
  re-draft)         shift; exec "$PYTHON" -m asr_training.cli re-draft "$@" ;;
  editor)
    shift
    echo "Starting transcript editor at http://localhost:3000"
    cd "$ROOT/services/transcript-editor"
    exec npx next dev
    ;;
  setup)     python3 -m venv .venv && .venv/bin/pip install --upgrade pip && make install ;;
  install)   exec make install ;;
  *)         echo "Usage: ./ambara <command> [options]"
             echo ""
             echo "Pipeline (recommended):"
             echo "  ingest     Download + extract + sync — one command to go from audio to Supabase"
             echo "  iterate    Export + train + re-draft — one command to improve the model"
             echo "  editor     Open transcript correction UI"
             echo ""
             echo "Individual steps:"
             echo "  download        Download YouTube audio as 16kHz mono WAV"
             echo "  extract         Run full clip extraction pipeline"
             echo "  vad-only        Run VAD detection only"
             echo "  sync            Sync extraction run to Supabase"
             echo "  export          Export corrected clips to CSV"
             echo "  export-training Export corrected clips as a training dataset"
             echo "  train           Fine-tune Whisper on exported training data"
             echo "  re-draft        Re-transcribe pending clips with a fine-tuned model"
             echo ""
             echo "Database:"
             echo "  delete-run      Delete a run and all its data from Supabase"
             echo "  reset           Wipe all runs, clips, edits, and storage"
             echo "  cleanup         Remove orphaned data"
             echo ""
             echo "Setup:"
             echo "  setup           Create venv and install all packages"
             echo "  install         Install local packages (editable)"
             echo ""
             echo "Examples:"
             echo "  ./ambara ingest 'https://youtube.com/watch?v=...' -l church-mass --device mps"
             echo "  ./ambara ingest -i data/input/recording.wav -l session1 --device mps -v"
             echo "  ./ambara editor"
             echo "  ./ambara iterate -l session1 --device mps"
             echo "  ./ambara iterate -l session1 --device cuda --push-to-hub user/whisper-mg"
             ;;
esac
